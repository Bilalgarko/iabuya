<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Supermarket Management System</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 30px; }
        h2 { margin-top: 40px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #aaa; padding: 8px; text-align: left; }
        input, button, select { margin: 5px 0; padding: 5px; }
        .flex { display: flex; gap: 30px; }
        .receipt { background: #f4f4f4; padding: 15px; margin-top: 20px; width: 400px;}
        .saved-receipts { margin-top: 20px; }
        .share-section { margin-top: 10px; }
        .share-link, .share-copy { margin-right: 10px; }
        .receipt-actions button { margin-right: 5px; }
        #loginBox { max-width: 350px; margin: 60px auto; padding: 30px; border: 1px solid #aaa; border-radius: 10px; background: #f9f9f9;}
        #mainApp { display: none; }
        .logout-btn { float: right; margin-top: 10px; }
        @media print {
            body * { visibility: hidden; }
            #pdfArea, #pdfArea * { visibility: visible; }
            #pdfArea { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>
    <div id="loginBox">
        <h2>Login</h2>
        <form id="loginForm">
            <label>Username: <input type="text" id="loginUsername" required></label><br>
            <label>Password: <input type="password" id="loginPassword" required></label><br>
            <button type="submit">Login</button>
        </form>
        <div id="loginMsg" style="color:red;margin-top:10px;"></div>
    </div>

    <div id="mainApp">
        <button class="logout-btn" onclick="logout()">Logout</button>
        <h1>Supermarket Management System</h1>
        <h2>Shop Profile - Inventory Management</h2>
        <form id="addItemForm">
            <label>Item Name: <input type="text" id="itemName" required></label>
            <label>Date In: <input type="date" id="dateIn" required></label>
            <label>Purchase Price: <input type="number" id="priceIn" min="0" step="0.01" required></label>
            <label>Quantity In: <input type="number" id="qtyIn" min="1" required></label>
            <button type="submit">Add Stock</button>
        </form>

        <form id="removeItemForm">
            <label>Item Name: <select id="itemOutName"></select></label>
            <label>Date Out: <input type="date" id="dateOut"></label>
            <label>Quantity Out: <input type="number" id="qtyOut" min="1"></label>
            <button type="submit">Remove Stock (sold/lost)</button>
        </form>

        <h3>Current Stock</h3>
        <table id="stockTable">
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Date In</th>
                    <th>Purchase Price</th>
                    <th>Quantity In</th>
                    <th>Quantity Out</th>
                    <th>Balance</th>
                </tr>
            </thead>
            <tbody>
                <!-- Stock rows here -->
            </tbody>
        </table>

        <hr>

        <h2>Sales Entry</h2>
        <form id="saleForm">
            <label>Item: <select id="saleItem"></select></label>
            <label>Rate (Selling Price): <input type="number" id="saleRate" min="0" step="0.01" required></label>
            <label>Quantity: <input type="number" id="saleQty" min="1" required></label>
            <button type="button" onclick="addSaleItem()">Add to Cart</button>
        </form>

        <h3>Sale Cart</h3>
        <table id="cartTable">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Rate</th>
                    <th>Qty</th>
                    <th>Subtotal</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Cart items here -->
            </tbody>
        </table>
        <div>
            <strong>Grand Total: â‚¦<span id="grandTotal">0.00</span></strong>
        </div>
        <button onclick="printReceipt()">Print Receipt</button>
        <button onclick="downloadPDF()">Download PDF</button>

        <div class="receipt" id="receipt" style="display:none"></div>
        <div id="pdfArea" style="display:none;"></div>
        <div class="receipt-actions" id="receiptActions" style="display:none">
            <button onclick="saveReceipt()">Save Receipt</button>
            <button onclick="shareReceiptLink()">Share Receipt Link</button>
            <button onclick="copyReceiptText()">Copy Receipt Text</button>
        </div>
        <div class="share-section" id="shareSection" style="display:none">
            <input type="text" id="shareLink" class="share-link" readonly style="width: 90%">
            <button onclick="copyToClipboard()">Copy Link</button>
        </div>

        <div class="saved-receipts">
            <h3>Past Receipts</h3>
            <ul id="pastReceipts"></ul>
        </div>
    </div>

    <script>
        // Simple credentials for demo (replace with your own secure method!)
        const DEMO_USER = 'admin';
        const DEMO_PASS = '12345';

        function logout() {
            localStorage.removeItem('loggedIn');
            location.reload();
        }

        // Login logic
        document.getElementById('loginForm').onsubmit = function(e) {
            e.preventDefault();
            let u = document.getElementById('loginUsername').value.trim();
            let p = document.getElementById('loginPassword').value;
            if(u === DEMO_USER && p === DEMO_PASS) {
                localStorage.setItem('loggedIn', 'yes');
                document.getElementById('loginBox').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
            } else {
                document.getElementById('loginMsg').textContent = 'Invalid username or password!';
            }
        };

        // Show main app if logged in
        if(localStorage.getItem('loggedIn') === 'yes') {
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        // Inventory data
        let inventory = [];
        // Sales cart
        let cart = [];
        // Last receipt object for sharing/saving
        let lastReceipt = null;

        // Add stock
        document.getElementById('addItemForm').onsubmit = function(e) {
            e.preventDefault();
            let name = document.getElementById('itemName').value.trim();
            let dateIn = document.getElementById('dateIn').value;
            let priceIn = parseFloat(document.getElementById('priceIn').value);
            let qtyIn = parseInt(document.getElementById('qtyIn').value);

            let item = inventory.find(i => i.name === name);
            if(item) {
                item.entries.push({dateIn, priceIn, qtyIn, qtyOut: 0});
            } else {
                inventory.push({
                    name,
                    entries: [{dateIn, priceIn, qtyIn, qtyOut: 0}]
                });
            }
            updateStockTables();
            document.getElementById('addItemForm').reset();
        };

        // Remove stock (sold/lost/damaged)
        document.getElementById('removeItemForm').onsubmit = function(e) {
            e.preventDefault();
            let name = document.getElementById('itemOutName').value;
            let dateOut = document.getElementById('dateOut').value;
            let qtyOut = parseInt(document.getElementById('qtyOut').value);

            let item = inventory.find(i => i.name === name);
            if(item) {
                for(let entry of item.entries) {
                    let available = entry.qtyIn - entry.qtyOut;
                    if(available >= qtyOut) {
                        entry.qtyOut += qtyOut;
                        break;
                    }
                }
            }
            updateStockTables();
            document.getElementById('removeItemForm').reset();
        };

        function updateStockTables() {
            let tbody = document.querySelector('#stockTable tbody');
            tbody.innerHTML = '';
            let itemOutSelect = document.getElementById('itemOutName');
            let saleItemSelect = document.getElementById('saleItem');
            itemOutSelect.innerHTML = '';
            saleItemSelect.innerHTML = '';

            for(let item of inventory) {
                itemOutSelect.innerHTML += `<option value="${item.name}">${item.name}</option>`;
                saleItemSelect.innerHTML += `<option value="${item.name}">${item.name}</option>`;
                for(let entry of item.entries) {
                    let balance = entry.qtyIn - entry.qtyOut;
                    let row = `<tr>
                        <td>${item.name}</td>
                        <td>${entry.dateIn}</td>
                        <td>${entry.priceIn.toFixed(2)}</td>
                        <td>${entry.qtyIn}</td>
                        <td>${entry.qtyOut}</td>
                        <td>${balance}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                }
            }
        }

        // Add item to sale cart
        function addSaleItem() {
            let name = document.getElementById('saleItem').value;
            let rate = parseFloat(document.getElementById('saleRate').value);
            let qty = parseInt(document.getElementById('saleQty').value);

            let item = inventory.find(i => i.name === name);
            let totalAvailable = item ? item.entries.reduce((s, e) => s + (e.qtyIn - e.qtyOut), 0) : 0;
            if(qty > totalAvailable) {
                alert('Not enough stock available!');
                return;
            }

            cart.push({name, rate, qty, subtotal: rate * qty});
            updateCartTable();
        }

        // Remove item from cart
        function removeCartItem(idx) {
            cart.splice(idx, 1);
            updateCartTable();
        }

        function updateCartTable() {
            let tbody = document.querySelector('#cartTable tbody');
            tbody.innerHTML = '';
            let grandTotal = 0;
            cart.forEach((item, idx) => {
                grandTotal += item.subtotal;
                tbody.innerHTML += `<tr>
                    <td>${item.name}</td>
                    <td>â‚¦${item.rate.toFixed(2)}</td>
                    <td>${item.qty}</td>
                    <td>â‚¦${item.subtotal.toFixed(2)}</td>
                    <td><button onclick="removeCartItem(${idx})">Remove</button></td>
                </tr>`;
            });
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
        }

        // Print Receipt
        function printReceipt() {
            if(cart.length === 0) return alert('No items in cart!');
            let now = new Date();
            let receiptObj = {
                date: now.toLocaleDateString(),
                time: now.toLocaleTimeString(),
                items: JSON.parse(JSON.stringify(cart)),
                grandTotal: cart.reduce((sum, item) => sum + item.subtotal, 0)
            };
            let receipt = `<h4>Supermarket Receipt</h4>
                <div>Date: ${receiptObj.date} ${receiptObj.time}</div>
                <table style="width:100%;margin:10px 0;">
                    <tr><th>Item</th><th>Rate</th><th>Qty</th><th>Subtotal</th></tr>`;
            receiptObj.items.forEach(item => {
                receipt += `<tr>
                    <td>${item.name}</td>
                    <td>â‚¦${item.rate.toFixed(2)}</td>
                    <td>${item.qty}</td>
                    <td>â‚¦${item.subtotal.toFixed(2)}</td>
                </tr>`;
            });
            receipt += `</table>
                <div><strong>Grand Total: â‚¦${receiptObj.grandTotal.toFixed(2)}</strong></div>
                <div>Thank you for shopping!</div>`;
            document.getElementById('receipt').innerHTML = receipt;
            document.getElementById('receipt').style.display = 'block';
            document.getElementById('receiptActions').style.display = 'block';
            document.getElementById('shareSection').style.display = 'none';
            lastReceipt = receiptObj;

            // Deduct sold quantity from inventory automatically
            cart.forEach(item => {
                let invItem = inventory.find(i => i.name === item.name);
                let qtyToDeduct = item.qty;
                for(let entry of invItem.entries) {
                    let available = entry.qtyIn - entry.qtyOut;
                    if(available >= qtyToDeduct) {
                        entry.qtyOut += qtyToDeduct;
                        break;
                    } else if(available > 0) {
                        qtyToDeduct -= available;
                        entry.qtyOut += available;
                    }
                }
            });
            cart = [];
            updateCartTable();
            updateStockTables();

            // Prepare receipt for PDF printing
            document.getElementById('pdfArea').innerHTML = receipt;
        }

        // Save Receipt to localStorage
        function saveReceipt() {
            if (!lastReceipt) return;
            let receipts = JSON.parse(localStorage.getItem('supermarketReceipts') || "[]");
            let id = Date.now();
            receipts.push({id, ...lastReceipt});
            localStorage.setItem('supermarketReceipts', JSON.stringify(receipts));
            alert('Receipt saved!');
            renderPastReceipts();
        }

        function renderPastReceipts() {
            let receipts = JSON.parse(localStorage.getItem('supermarketReceipts') || "[]");
            let ul = document.getElementById('pastReceipts');
            ul.innerHTML = '';
            receipts.forEach(r => {
                let li = document.createElement('li');
                li.innerHTML = `Receipt: ${r.date} ${r.time} | Total: â‚¦${r.grandTotal.toFixed(2)}
                    <button onclick='loadReceipt(${r.id})'>View</button>
                    <button onclick='deleteReceipt(${r.id})'>Delete</button>`;
                ul.appendChild(li);
            });
        }

        function loadReceipt(id) {
            let receipts = JSON.parse(localStorage.getItem('supermarketReceipts') || "[]");
            let receiptObj = receipts.find(r => r.id === id);
            if (!receiptObj) return;
            lastReceipt = receiptObj;
            let receipt = `<h4>Supermarket Receipt</h4>
                <div>Date: ${receiptObj.date} ${receiptObj.time}</div>
                <table style="width:100%;margin:10px 0;">
                    <tr><th>Item</th><th>Rate</th><th>Qty</th><th>Subtotal</th></tr>`;
            receiptObj.items.forEach(item => {
                receipt += `<tr>
                    <td>${item.name}</td>
                    <td>â‚¦${item.rate.toFixed(2)}</td>
                    <td>${item.qty}</td>
                    <td>â‚¦${item.subtotal.toFixed(2)}</td>
                </tr>`;
            });
            receipt += `</table>
                <div><strong>Grand Total: â‚¦${receiptObj.grandTotal.toFixed(2)}</strong></div>
                <div>Thank you for shopping!</div>`;
            document.getElementById('receipt').innerHTML = receipt;
            document.getElementById('receipt').style.display = 'block';
            document.getElementById('receiptActions').style.display = 'block';
            document.getElementById('shareSection').style.display = 'none';
            document.getElementById('pdfArea').innerHTML = receipt;
        }

        function deleteReceipt(id) {
            if (!confirm("Delete this receipt?")) return;
            let receipts = JSON.parse(localStorage.getItem('supermarketReceipts') || "[]");
            receipts = receipts.filter(r => r.id !== id);
            localStorage.setItem('supermarketReceipts', JSON.stringify(receipts));
            renderPastReceipts();
        }

        function shareReceiptLink() {
            if (!lastReceipt) return;
            let data = encodeURIComponent(JSON.stringify(lastReceipt));
            let url = `${location.origin}${location.pathname}?receipt=${data}`;
            document.getElementById('shareLink').value = url;
            document.getElementById('shareSection').style.display = 'block';
        }

        function copyReceiptText() {
            let receiptDiv = document.getElementById('receipt');
            let temp = document.createElement('textarea');
            temp.value = receiptDiv.innerText;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            alert('Receipt text copied to clipboard!');
        }

        function copyToClipboard() {
            let link = document.getElementById('shareLink');
            link.select();
            document.execCommand('copy');
            alert('Shareable link copied!');
        }

        function checkReceiptUrl() {
            let params = new URLSearchParams(window.location.search);
            if (params.has('receipt')) {
                try {
                    let receiptObj = JSON.parse(decodeURIComponent(params.get('receipt')));
                    lastReceipt = receiptObj;
                    let receipt = `<h4>Supermarket Receipt (Shared)</h4>
                        <div>Date: ${receiptObj.date} ${receiptObj.time}</div>
                        <table style="width:100%;margin:10px 0;">
                            <tr><th>Item</th><th>Rate</th><th>Qty</th><th>Subtotal</th></tr>`;
                    receiptObj.items.forEach(item => {
                        receipt += `<tr>
                            <td>${item.name}</td>
                            <td>â‚¦${item.rate.toFixed(2)}</td>
                            <td>${item.qty}</td>
                            <td>â‚¦${item.subtotal.toFixed(2)}</td>
                        </tr>`;
                    });
                    receipt += `</table>
                        <div><strong>Grand Total: â‚¦${receiptObj.grandTotal.toFixed(2)}</strong></div>
                        <div>Thank you for shopping!</div>`;
                    document.getElementById('receipt').innerHTML = receipt;
                    document.getElementById('receipt').style.display = 'block';
                    document.getElementById('receiptActions').style.display = 'block';
                    document.getElementById('pdfArea').innerHTML = receipt;
                } catch (e) {}
            }
        }

        // PDF Download feature
        function downloadPDF() {
            // Use browser print to PDF
            let pdfArea = document.getElementById('pdfArea');
            if(pdfArea.innerHTML.trim() === "") {
                alert("Please generate a receipt first!");
                return;
            }
            pdfArea.style.display = "block";
            window.print();
            pdfArea.style.display = "none";
        }

        updateStockTables();
        renderPastReceipts();
        checkReceiptUrl();
    </script>
</body>
</html>
