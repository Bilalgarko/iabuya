<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Supermarket Management System</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 30px; }
        h2 { margin-top: 40px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #aaa; padding: 8px; text-align: left; }
        input, button, select { margin: 5px 0; padding: 5px; }
        .flex { display: flex; gap: 30px; }
        .receipt { background: #f4f4f4; padding: 15px; margin-top: 20px; width: 400px;}
    </style>
</head>
<body>
    <h1>Supermarket Management System</h1>
    <h2>Shop Profile - Inventory Management</h2>
    <form id="addItemForm">
        <label>Item Name: <input type="text" id="itemName" required></label>
        <label>Date In: <input type="date" id="dateIn" required></label>
        <label>Purchase Price: <input type="number" id="priceIn" min="0" step="0.01" required></label>
        <label>Quantity In: <input type="number" id="qtyIn" min="1" required></label>
        <button type="submit">Add Stock</button>
    </form>

    <form id="removeItemForm">
        <label>Item Name: <select id="itemOutName"></select></label>
        <label>Date Out: <input type="date" id="dateOut"></label>
        <label>Quantity Out: <input type="number" id="qtyOut" min="1"></label>
        <button type="submit">Remove Stock (sold/lost)</button>
    </form>

    <h3>Current Stock</h3>
    <table id="stockTable">
        <thead>
            <tr>
                <th>Item Name</th>
                <th>Date In</th>
                <th>Purchase Price</th>
                <th>Quantity In</th>
                <th>Quantity Out</th>
                <th>Balance</th>
            </tr>
        </thead>
        <tbody>
            <!-- Stock rows here -->
        </tbody>
    </table>

    <hr>

    <h2>Sales Entry</h2>
    <form id="saleForm">
        <label>Item: <select id="saleItem"></select></label>
        <label>Rate (Selling Price): <input type="number" id="saleRate" min="0" step="0.01" required></label>
        <label>Quantity: <input type="number" id="saleQty" min="1" required></label>
        <button type="button" onclick="addSaleItem()">Add to Cart</button>
    </form>

    <h3>Sale Cart</h3>
    <table id="cartTable">
        <thead>
            <tr>
                <th>Item</th>
                <th>Rate</th>
                <th>Qty</th>
                <th>Subtotal</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <!-- Cart items here -->
        </tbody>
    </table>
    <div>
        <strong>Grand Total: ₦<span id="grandTotal">0.00</span></strong>
    </div>
    <button onclick="printReceipt()">Print Receipt</button>

    <div class="receipt" id="receipt" style="display:none"></div>

    <script>
        // Inventory data
        let inventory = [];
        // Sales cart
        let cart = [];

        // Add stock
        document.getElementById('addItemForm').onsubmit = function(e) {
            e.preventDefault();
            let name = document.getElementById('itemName').value.trim();
            let dateIn = document.getElementById('dateIn').value;
            let priceIn = parseFloat(document.getElementById('priceIn').value);
            let qtyIn = parseInt(document.getElementById('qtyIn').value);

            // Check if item exists (by name)
            let item = inventory.find(i => i.name === name);
            if(item) {
                // Add new stock batch
                item.entries.push({dateIn, priceIn, qtyIn, qtyOut: 0});
            } else {
                inventory.push({
                    name,
                    entries: [{dateIn, priceIn, qtyIn, qtyOut: 0}]
                });
            }
            updateStockTables();
            document.getElementById('addItemForm').reset();
        };

        // Remove stock (sold/lost/damaged)
        document.getElementById('removeItemForm').onsubmit = function(e) {
            e.preventDefault();
            let name = document.getElementById('itemOutName').value;
            let dateOut = document.getElementById('dateOut').value;
            let qtyOut = parseInt(document.getElementById('qtyOut').value);

            let item = inventory.find(i => i.name === name);
            if(item) {
                // Remove from latest batch that has enough quantity
                for(let entry of item.entries) {
                    let available = entry.qtyIn - entry.qtyOut;
                    if(available >= qtyOut) {
                        entry.qtyOut += qtyOut;
                        break;
                    }
                }
            }
            updateStockTables();
            document.getElementById('removeItemForm').reset();
        };

        // Update stock tables and dropdowns
        function updateStockTables() {
            let tbody = document.querySelector('#stockTable tbody');
            tbody.innerHTML = '';
            let itemOutSelect = document.getElementById('itemOutName');
            let saleItemSelect = document.getElementById('saleItem');
            itemOutSelect.innerHTML = '';
            saleItemSelect.innerHTML = '';

            for(let item of inventory) {
                itemOutSelect.innerHTML += `<option value="${item.name}">${item.name}</option>`;
                saleItemSelect.innerHTML += `<option value="${item.name}">${item.name}</option>`;
                for(let entry of item.entries) {
                    let balance = entry.qtyIn - entry.qtyOut;
                    let row = `<tr>
                        <td>${item.name}</td>
                        <td>${entry.dateIn}</td>
                        <td>${entry.priceIn.toFixed(2)}</td>
                        <td>${entry.qtyIn}</td>
                        <td>${entry.qtyOut}</td>
                        <td>${balance}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                }
            }
        }

        // Add item to sale cart
        function addSaleItem() {
            let name = document.getElementById('saleItem').value;
            let rate = parseFloat(document.getElementById('saleRate').value);
            let qty = parseInt(document.getElementById('saleQty').value);

            // Check stock
            let item = inventory.find(i => i.name === name);
            let totalAvailable = item ? item.entries.reduce((s, e) => s + (e.qtyIn - e.qtyOut), 0) : 0;
            if(qty > totalAvailable) {
                alert('Not enough stock available!');
                return;
            }

            // Add to cart
            cart.push({name, rate, qty, subtotal: rate * qty});
            updateCartTable();
        }

        // Remove item from cart
        function removeCartItem(idx) {
            cart.splice(idx, 1);
            updateCartTable();
        }

        // Update cart table and grand total
        function updateCartTable() {
            let tbody = document.querySelector('#cartTable tbody');
            tbody.innerHTML = '';
            let grandTotal = 0;
            cart.forEach((item, idx) => {
                grandTotal += item.subtotal;
                tbody.innerHTML += `<tr>
                    <td>${item.name}</td>
                    <td>₦${item.rate.toFixed(2)}</td>
                    <td>${item.qty}</td>
                    <td>₦${item.subtotal.toFixed(2)}</td>
                    <td><button onclick="removeCartItem(${idx})">Remove</button></td>
                </tr>`;
            });
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
        }

        // Print Receipt
        function printReceipt() {
            if(cart.length === 0) return alert('No items in cart!');
            let now = new Date();
            let receipt = `<h4>Supermarket Receipt</h4>
                <div>Date: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}</div>
                <table style="width:100%;margin:10px 0;">
                    <tr><th>Item</th><th>Rate</th><th>Qty</th><th>Subtotal</th></tr>`;
            let grandTotal = 0;
            cart.forEach(item => {
                receipt += `<tr>
                    <td>${item.name}</td>
                    <td>₦${item.rate.toFixed(2)}</td>
                    <td>${item.qty}</td>
                    <td>₦${item.subtotal.toFixed(2)}</td>
                </tr>`;
                grandTotal += item.subtotal;

                // Deduct sold quantity from inventory
                let invItem = inventory.find(i => i.name === item.name);
                let qtyToDeduct = item.qty;
                for(let entry of invItem.entries) {
                    let available = entry.qtyIn - entry.qtyOut;
                    if(available >= qtyToDeduct) {
                        entry.qtyOut += qtyToDeduct;
                        break;
                    } else if(available > 0) {
                        qtyToDeduct -= available;
                        entry.qtyOut += available;
                    }
                }
            });
            receipt += `</table>
                <div><strong>Grand Total: ₦${grandTotal.toFixed(2)}</strong></div>
                <div>Thank you for shopping!</div>`;
            document.getElementById('receipt').innerHTML = receipt;
            document.getElementById('receipt').style.display = 'block';
            // Clear cart
            cart = [];
            updateCartTable();
            updateStockTables();
        }

        // Initial call
        updateStockTables();
    </script>
</body>
</html>
